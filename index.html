<script>
  const dot = document.getElementById("dot");
  const statusText = document.getElementById("statusText");
  const subText = document.getElementById("subText");
  const btnStart = document.getElementById("btnStart");
  const count = document.getElementById("count");
  const count2 = document.getElementById("count2");
  const rightInfo = document.getElementById("rightInfo");
  const grid = document.getElementById("grid");
  const grid2 = document.getElementById("grid2");

  let malls = [];

  // tabs
  document.querySelectorAll(".tab").forEach(t => {
    t.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      const key = t.dataset.tab;
      document.querySelectorAll("[id^='tab-']").forEach(p => p.classList.add("hidden"));
      document.getElementById("tab-" + key).classList.remove("hidden");
    });
  });

  function toNum(v) {
    const n = Number(String(v || "").replace(/[^\d]/g, ""));
    return Number.isFinite(n) ? n : null;
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function normalizeSmartstoreHome(urlStr) {
    try {
      const u = new URL(urlStr);
      if (!u.hostname.includes("smartstore.naver.com")) return urlStr;
      const seg = u.pathname.split("/").filter(Boolean);
      if (seg.length === 0) return urlStr;
      return `${u.origin}/${seg[0]}`;
    } catch {
      return urlStr || "";
    }
  }

  function getMallHome(m) {
    if (m.mallUrl) return normalizeSmartstoreHome(m.mallUrl);
    return "";
  }

  function renderCards(targetGrid, list) {
    targetGrid.innerHTML = "";

    list.forEach((m) => {
      const home = getMallHome(m);

      const div = document.createElement("div");
      div.className = "card";

      div.innerHTML = `
        ${home ? `
          
            href="${escapeHtml(home)}"
            target="_blank"
            rel="noopener noreferrer"
            style="position:absolute; inset:0; z-index:5;"
            aria-label="open mall"
          ></a>
        ` : ""}

        <div class="logo">P</div>
        <div style="min-width:0;flex:1;pointer-events:none">
          <div class="mall">${escapeHtml(m.mallName || "SMARTSTORE")}</div>
          <div class="meta">수집 상품: ${m.count ?? 1}개</div>
          <div class="tag">NAVER SHOPPING</div>
          ${!home ? `<div class="debug">쇼핑몰 URL 없음</div>` : ``}
        </div>
      `;

      targetGrid.appendChild(div);
    });
  }

  // 메시지 수신
  window.addEventListener("message", (e) => {
    const msg = e.data;
    if (!msg || typeof msg !== "object") return;

    console.log("index.html received:", msg);

    // 상태 업데이트
    if (msg.type === "UPS_STATUS") {
      dot.className = "dot ok";
      statusText.textContent = "수집 진행 중...";
      subText.textContent = `단계: ${msg.stage || "-"} | 페이지: ${msg.page || "-"}`;
      if (msg.keyword) rightInfo.textContent = `키워드: ${msg.keyword}`;
    }

    // 수집 완료
    if (msg.type === "UPS_DONE") {
      console.log("UPS_DONE received:", msg);
      
      if (!msg.ok) {
        dot.className = "dot bad";
        statusText.textContent = "수집 실패";
        subText.textContent = msg.error || "알 수 없는 오류";
        btnStart.disabled = false;
        btnStart.textContent = "수집 시작";
        return;
      }

      const mallsList = msg.malls || [];
      malls = mallsList;

      console.log("Rendering malls:", mallsList);

      count.textContent = String(mallsList.length);
      count2.textContent = String(mallsList.length);

      renderCards(grid, mallsList);
      renderCards(grid2, mallsList);

      dot.className = "dot ok";
      statusText.textContent = "수집 완료!";
      subText.textContent = `총 ${mallsList.length}개 쇼핑몰 수집`;
      btnStart.disabled = false;
      btnStart.textContent = "수집 시작";
    }
  });

  // 수집 시작
  document.getElementById("form").addEventListener("submit", (e) => {
    e.preventDefault();
    const keyword = document.getElementById("keyword").value.trim();
    if (!keyword) return;

    const maxPage = toNum(document.getElementById("maxPage").value) || 4;
    const minPrice = toNum(document.getElementById("minPrice").value);
    const maxPrice = toNum(document.getElementById("maxPrice").value);

    grid.innerHTML = "";
    count.textContent = "0";
    dot.className = "dot";
    statusText.textContent = "수집 시작...";
    subText.textContent = "";
    btnStart.disabled = true;
    btnStart.textContent = "수집 중...";

    window.postMessage({
      type: "UPS_START",
      keyword,
      maxPage,
      minPrice,
      maxPrice
    }, "*");
  });
</script>