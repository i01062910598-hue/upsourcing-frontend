<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>업소싱 도구 - 쇼핑몰 수집</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui,
          sans-serif;
        background: #f5f7fb;
        color: #222;
      }

      header {
        background: linear-gradient(90deg, #ffb74d, #ff7043);
        padding: 14px 32px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .logo {
        font-size: 18px;
        font-weight: 700;
        letter-spacing: 0.03em;
      }

      nav {
        display: flex;
        gap: 8px;
      }

      .nav-btn {
        border: none;
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        padding: 8px 14px;
        border-radius: 999px;
        font-size: 13px;
        cursor: pointer;
        transition: background 0.15s ease, transform 0.05s ease;
      }

      .nav-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-1px);
      }

      .nav-btn.active {
        background: #fff;
        color: #ff7043;
        font-weight: 600;
      }

      .container {
        max-width: 1120px;
        margin: 24px auto 40px;
        padding: 0 16px;
      }

      .section {
        display: none;
      }

      .section.active {
        display: block;
      }

      .section-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 12px;
      }

      .section-sub {
        font-size: 13px;
        color: #777;
        margin-bottom: 20px;
      }

      .best-form {
        background: #ffffff;
        border-radius: 14px;
        padding: 18px 20px;
        box-shadow: 0 4px 16px rgba(15, 23, 42, 0.05);
        margin-bottom: 12px;
        display: grid;
        grid-template-columns: 2.5fr 1fr 1fr auto;
        gap: 10px;
        align-items: center;
      }

      .field-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .field-label {
        font-size: 11px;
        color: #666;
      }

      .field-input {
        height: 34px;
        border-radius: 8px;
        border: 1px solid #d0d7e2;
        padding: 0 10px;
        font-size: 13px;
      }

      .field-input:focus {
        outline: none;
        border-color: #ff7043;
        box-shadow: 0 0 0 2px rgba(255, 112, 67, 0.16);
      }

      .btn-primary {
        border: none;
        height: 36px;
        padding: 0 18px;
        border-radius: 999px;
        background: #ff7043;
        color: #fff;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
        transition: background 0.15s ease, transform 0.05s ease;
      }

      .btn-primary:hover {
        background: #ff5722;
        transform: translateY(-1px);
      }

      .btn-sub {
        border: none;
        height: 32px;
        padding: 0 12px;
        border-radius: 999px;
        background: #e3f2fd;
        color: #1565c0;
        font-size: 12px;
        cursor: pointer;
        white-space: nowrap;
      }

      .btn-danger {
        border: none;
        height: 32px;
        padding: 0 12px;
        border-radius: 999px;
        background: #ef5350;
        color: #fff;
        font-size: 12px;
        cursor: pointer;
        white-space: nowrap;
      }

      .mall-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 14px;
      }

      .mall-card {
        background: #ffffff;
        border-radius: 14px;
        padding: 14px 14px 12px;
        box-shadow: 0 4px 14px rgba(15, 23, 42, 0.06);
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: transform 0.06s ease, box-shadow 0.1s ease;
      }

      .mall-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.09);
      }

      .mall-logo {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: #f0f2f7;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        flex-shrink: 0;
      }

      .mall-logo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .mall-info {
        flex: 1;
        min-width: 0;
      }

      .mall-name {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .mall-meta {
        font-size: 11px;
        color: #888;
      }

      .mall-tag {
        font-size: 11px;
        color: #ff7043;
        background: rgba(255, 112, 67, 0.08);
        border-radius: 999px;
        padding: 2px 8px;
        display: inline-block;
        margin-top: 4px;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 3px 10px;
        border-radius: 999px;
        background: #e3f2fd;
        color: #1976d2;
        font-size: 11px;
      }

      .badge-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #4caf50;
      }

      .badge-dot.red {
        background: #ef5350;
      }

      .empty-text {
        font-size: 13px;
        color: #999;
        padding: 18px 4px;
      }

      .mall-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        margin-bottom: 12px;
      }

      .mall-toolbar input {
        height: 32px;
        border-radius: 999px;
        border: 1px solid #d0d7e2;
        padding: 0 12px;
        font-size: 12px;
        min-width: 180px;
      }

      .mall-toolbar select {
        height: 32px;
        border-radius: 999px;
        border: 1px solid #d0d7e2;
        padding: 0 10px;
        font-size: 12px;
      }

      .stub-box {
        background: #ffffff;
        border-radius: 14px;
        padding: 18px 20px;
        box-shadow: 0 4px 16px rgba(15, 23, 42, 0.05);
        font-size: 13px;
        color: #666;
      }

      .status-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 12px;
      }

      .status-text {
        font-size: 12px;
        color: #666;
      }

      @media (max-width: 800px) {
        .best-form {
          grid-template-columns: 1fr;
        }

        header {
          padding: 10px 14px;
        }

        nav {
          gap: 4px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo">업소싱 도구 · 해외구매대행 소싱</div>
      <nav>
        <button class="nav-btn active" data-target="best">BEST소싱</button>
        <button class="nav-btn" data-target="malls">수집된 쇼핑몰</button>
        <button class="nav-btn" data-target="upload">상품 업로드</button>
        <button class="nav-btn" data-target="settings">설정</button>
      </nav>
    </header>

    <main class="container">
      <section id="section-best" class="section active">
        <h2 class="section-title">스마트스토어 BEST 소싱</h2>
        <p class="section-sub">
          키워드를 입력하면, 확장프로그램이 네이버쇼핑을 열고 상품을 수집한 뒤 결과를
          이 화면으로 돌려줍니다.
        </p>

        <form id="collectForm" class="best-form">
          <div class="field-group">
            <span class="field-label">검색 키워드</span>
            <input
              type="text"
              id="keywordInput"
              class="field-input"
              placeholder="예: 겨울신발, 스타킹, 니트, 남자 맨투맨"
              required
            />
          </div>

          <div class="field-group">
            <span class="field-label">최소 가격</span>
            <input
              type="number"
              id="minPriceInput"
              class="field-input"
              placeholder="예: 10000"
            />
          </div>

          <div class="field-group">
            <span class="field-label">최대 가격</span>
            <input
              type="number"
              id="maxPriceInput"
              class="field-input"
              placeholder="예: 200000"
            />
          </div>

          <button id="collectBtn" type="submit" class="btn-primary">
            쇼핑몰 수집
          </button>
        </form>

        <div class="status-row">
          <span id="extBadge" class="badge">
            <span id="extDot" class="badge-dot red"></span>
            <span id="extText">확장프로그램 연결 확인 중...</span>
          </span>
          <span class="status-text" id="runText"></span>
        </div>

        <div id="mallList" class="mall-list"></div>
        <div id="mallEmpty" class="empty-text" style="display: none">
          아직 수집된 쇼핑몰이 없습니다. 키워드를 입력하고
          <strong>쇼핑몰 수집</strong> 버튼을 눌러주세요.
        </div>
      </section>

      <section id="section-malls" class="section">
        <h2 class="section-title">수집된 쇼핑몰</h2>
        <p class="section-sub">
          BEST 탭과 동일한 “쇼핑몰” 기준으로 보여줍니다. (필터/정렬 지원)
        </p>

        <div class="mall-toolbar">
          <input
            type="text"
            id="mallFilterInput"
            placeholder="키워드 또는 쇼핑몰명 검색"
          />
          <select id="mallSortSelect">
            <option value="recent">최근 수집순</option>
            <option value="name">이름 순</option>
          </select>
          <button id="mallReloadBtn" class="btn-sub">새로고침</button>
          <button id="mallClearBtn" class="btn-danger">전체 삭제</button>
        </div>

        <div id="mallList2" class="mall-list"></div>
        <div id="mallEmpty2" class="empty-text" style="display: none">
          아직 수집된 쇼핑몰이 없습니다.
        </div>
      </section>

      <section id="section-upload" class="section">
        <h2 class="section-title">상품 업로드 (준비중)</h2>
        <p class="section-sub">
          이후 단계에서 업로드 대기 상품 리스트 / 상세 편집 / 업로드 버튼 등을 구성합니다.
        </p>
        <div class="stub-box">
          · 지금은 BEST소싱 → 수집/표시 흐름을 먼저 완성하는 단계입니다.
        </div>
      </section>

      <section id="section-settings" class="section">
        <h2 class="section-title">설정 (준비중)</h2>
        <p class="section-sub">마진율, 출고 소요일, API 키 등을 관리하는 영역입니다.</p>
        <div class="stub-box">· 현재는 UI 뼈대만 있습니다.</div>
      </section>
    </main>

    <script>
      // --------------------------
      // 탭 전환
      // --------------------------
      const navButtons = document.querySelectorAll(".nav-btn");
      const sections = {
        best: document.getElementById("section-best"),
        malls: document.getElementById("section-malls"),
        upload: document.getElementById("section-upload"),
        settings: document.getElementById("section-settings"),
      };

      navButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          navButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          const target = btn.dataset.target;
          Object.keys(sections).forEach((key) => {
            sections[key].classList.toggle("active", key === target);
          });

          if (target === "malls") {
            renderSecondTabFromLastRun();
          }
        });
      });

      // --------------------------
      // UI 엘리먼트
      // --------------------------
      const mallList = document.getElementById("mallList");
      const mallEmpty = document.getElementById("mallEmpty");
      const mallList2 = document.getElementById("mallList2");
      const mallEmpty2 = document.getElementById("mallEmpty2");

      const collectBtn = document.getElementById("collectBtn");
      const extDot = document.getElementById("extDot");
      const extText = document.getElementById("extText");
      const runText = document.getElementById("runText");

      const mallFilterInput = document.getElementById("mallFilterInput");
      const mallSortSelect = document.getElementById("mallSortSelect");
      const mallReloadBtn = document.getElementById("mallReloadBtn");
      const mallClearBtn = document.getElementById("mallClearBtn");

      // --------------------------
      // 상태 저장(이번 실행 결과 임시)
      // lastRun: { malls:[], items:[], keyword, totalItems, ts }
      // --------------------------
      let lastRun = null;

      // --------------------------
      // utils
      // --------------------------
      const FALLBACK_IMG = "https://placehold.co/64x64?text=P";

      function escapeHtml(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function safeHttpUrl(u) {
        const s = String(u ?? "").trim();
        if (!s) return "";
        if (s.startsWith("http://") || s.startsWith("https://")) return s;
        return "";
      }

      function pick(obj, keys) {
        for (const k of keys) {
          if (obj && obj[k] != null && String(obj[k]).trim() !== "") return obj[k];
        }
        return "";
      }

      // payload 구조가 다양해서 “쇼핑몰(묶음)”을 표준형으로 변환
      function normalizeMallGroup(g) {
        // g.items가 상품배열인 케이스
        const items = Array.isArray(g?.items) ? g.items : Array.isArray(g?.products) ? g.products : [];
        const mallName = pick(g, ["mallName", "mall_name", "mall", "seller", "name", "title"]) || "UNKNOWN";
        const mallUrl = safeHttpUrl(pick(g, ["mallUrl", "mall_url", "shopUrl", "shop_url", "sellerUrl", "seller_url", "url", "link", "href"]));
        const imageUrl =
          safeHttpUrl(pick(g, ["imageUrl", "image_url", "logoUrl", "logo_url", "image", "logo"])) || FALLBACK_IMG;

        // 첫 상품 url (mallUrl 없을 때 열 용도)
        const firstItem = items?.[0] || null;
        const firstItemUrl = firstItem
          ? safeHttpUrl(pick(firstItem, ["productUrl", "product_url", "url", "link", "href"]))
          : "";

        return {
          mallName,
          mallUrl,
          imageUrl,
          items,
          count: items?.length || 0,
          openUrl: mallUrl || firstItemUrl || "", // 여기로 클릭 연결
        };
      }

      // payload가 flat 상품 배열인 케이스도 “쇼핑몰 그룹”으로 묶어주는 함수(몰 기준)
      function groupFlatItemsToMalls(items) {
        const map = new Map();
        (items || []).forEach((it) => {
          const mallName = pick(it, ["mallName", "mall_name", "mall", "seller", "sellerName", "seller_name"]) || "UNKNOWN";
          const key = String(mallName);
          if (!map.has(key)) map.set(key, []);
          map.get(key).push(it);
        });
        const malls = [];
        for (const [mallName, arr] of map.entries()) {
          const g = {
            mallName,
            items: arr,
            // mallUrl이 상품에 있을 수도 있어서(희박) 첫번째에서 추정
            mallUrl: pick(arr?.[0], ["mallUrl", "mall_url", "sellerUrl", "seller_url", "shopUrl", "shop_url"]) || "",
            imageUrl: pick(arr?.[0], ["mallImage", "mall_image", "logoUrl", "logo_url"]) || "",
          };
          malls.push(normalizeMallGroup(g));
        }
        return malls;
      }

      // --------------------------
      // 쇼핑몰 카드 렌더 (BEST/수집탭 공용)
      // malls: [{ mallName, count, imageUrl, openUrl }]
      // --------------------------
      function renderMallCards(malls, targetList, emptyEl) {
        targetList.innerHTML = "";

        if (!malls || malls.length === 0) {
          emptyEl.style.display = "block";
          return;
        }
        emptyEl.style.display = "none";

        malls.forEach((m) => {
          const card = document.createElement("div");
          card.className = "mall-card";

          const name = m.mallName || "UNKNOWN";
          const count = Number(m.count || 0);
          const img = safeHttpUrl(m.imageUrl) || FALLBACK_IMG;
          const openUrl = safeHttpUrl(m.openUrl);

          card.innerHTML = `
            <div class="mall-logo">
              <img src="${escapeHtml(img)}" alt="img">
            </div>
            <div class="mall-info">
              <div class="mall-name">${escapeHtml(name)}</div>
              <div class="mall-meta">수집 상품: ${count}개</div>
              <div class="mall-tag">NAVER SHOPPING</div>
            </div>
          `;

          // ✅ URL 없으면 아무것도 안열게 해서 랜덤 이동 방지
          card.addEventListener("click", () => {
            if (!openUrl) {
              alert("이 카드에 연결된 URL이 없습니다. (확장 수집 데이터 확인 필요)");
              return;
            }
            window.open(openUrl, "_blank", "noopener,noreferrer");
          });

          targetList.appendChild(card);
        });
      }

      // --------------------------
      // 2번째 탭(수집된 쇼핑몰) 렌더
      // --------------------------
      function renderSecondTabFromLastRun() {
        if (!lastRun || !lastRun.malls) {
          renderMallCards([], mallList2, mallEmpty2);
          return;
        }

        let malls = [...lastRun.malls];

        // 필터
        const q = (mallFilterInput.value || "").trim().toLowerCase();
        if (q) {
          malls = malls.filter((m) => {
            const blob = JSON.stringify(m).toLowerCase();
            return blob.includes(q);
          });
        }

        // 정렬
        const sort = mallSortSelect.value;
        if (sort === "name") {
          malls.sort((a, b) => String(a.mallName).localeCompare(String(b.mallName)));
        }

        renderMallCards(malls, mallList2, mallEmpty2);
      }

      // --------------------------
      // 확장프로그램 연결 안내
      // --------------------------
      function checkExtensionBridge() {
        extDot.style.background = "#ef5350";
        extText.textContent = "확장프로그램이 설치되어 있어야 동작합니다.";
      }
      checkExtensionBridge();

      // --------------------------
      // UPS_RESULT 수신 (확장 -> site)
      // --------------------------
      window.addEventListener("message", (e) => {
        if (!e || !e.data) return;

        if (e.data.type === "UPS_RESULT") {
          const payload = e.data.payload || {};
          console.log("[SITE] UPS_RESULT:", payload);

          const ok = !!payload.ok;
          if (!ok) {
            alert("수집 실패: " + (payload.error || "unknown"));
            collectBtn.disabled = false;
            collectBtn.textContent = "쇼핑몰 수집";
            return;
          }

          // 연결 표시
          extDot.style.background = "#4caf50";
          extText.textContent = "확장프로그램 연결됨 ✅";

          // ---------
          // ✅ payload 형태 자동 처리
          // 1) malls: [{ mallName, items:[...] }, ...]
          // 2) items: [{ productUrl, mallName, ... }, ...]
          // ---------
          const rawMalls = Array.isArray(payload.malls) ? payload.malls : [];
          const rawItems =
            Array.isArray(payload.items) ? payload.items :
            Array.isArray(payload.products) ? payload.products :
            [];

          let malls = [];
          if (rawMalls.length > 0) {
            malls = rawMalls.map(normalizeMallGroup);
          } else if (rawItems.length > 0) {
            malls = groupFlatItemsToMalls(rawItems);
          }

          const totalItems =
            payload.totalItems ??
            (rawItems.length ? rawItems.length : malls.reduce((acc, m) => acc + (m.count || 0), 0));

          runText.textContent = `총 ${totalItems}개 수집`;

          lastRun = {
            keyword: payload.keyword || "",
            malls,
            items: rawItems, // 추후 "상품 업로드" 탭에서 쓰려고 남겨둠
            totalItems,
            ts: Date.now(),
          };

          // ✅ BEST 탭: 쇼핑몰 카드로 표시
          renderMallCards(lastRun.malls, mallList, mallEmpty);

          collectBtn.disabled = false;
          collectBtn.textContent = "쇼핑몰 수집";
        }
      });

      // --------------------------
      // BEST소싱 폼 전송: 확장프로그램 start
      // --------------------------
      const collectForm = document.getElementById("collectForm");
      collectForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const keyword = document.getElementById("keywordInput").value.trim();
        const minPrice = document.getElementById("minPriceInput").value;
        const maxPrice = document.getElementById("maxPriceInput").value;

        if (!keyword) {
          alert("키워드를 입력해 주세요.");
          return;
        }

        // UI
        collectBtn.disabled = true;
        collectBtn.textContent = "수집 중...";
        runText.textContent = "";
        mallList.innerHTML = "";
        mallEmpty.style.display = "none";

        // 확장프로그램에게 수집 시작 메시지
        window.postMessage(
          {
            type: "UPS_START",
            keyword,
            maxPage: 4,
            minPrice: minPrice ? Number(minPrice) : null,
            maxPrice: maxPrice ? Number(maxPrice) : null,
          },
          "*"
        );

        // ✅ 응답 대기: 30초
        const startedAt = Date.now();
        setTimeout(() => {
          if (!lastRun || lastRun.ts < startedAt) {
            collectBtn.disabled = false;
            collectBtn.textContent = "쇼핑몰 수집";
            alert(
              "확장프로그램 응답이 없습니다.\n1) 확장프로그램 켜짐/권한 확인\n2) 페이지 새로고침 후 다시 시도"
            );
          }
        }, 30000);
      });

      // --------------------------
      // 두번째 탭 이벤트
      // --------------------------
      mallReloadBtn.addEventListener("click", renderSecondTabFromLastRun);
      mallSortSelect.addEventListener("change", renderSecondTabFromLastRun);
      mallFilterInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          renderSecondTabFromLastRun();
        }
      });

      mallClearBtn.addEventListener("click", async () => {
        if (!confirm("이번 실행 결과를 화면에서 지울까요?")) return;
        lastRun = null;
        renderMallCards([], mallList, mallEmpty);
        renderMallCards([], mallList2, mallEmpty2);
        runText.textContent = "";
      });

      // 초기 화면
      renderMallCards([], mallList, mallEmpty);
    </script>
  </body>
</html>